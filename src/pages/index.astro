---
import BaseLayout from '../layouts/BaseLayout.astro';
import SearchBar from '../components/SearchBar.astro';
import { getCollection } from 'astro:content';
import { generateWebSiteJsonLd } from '../utils/jsonld';

const allArticles = await getCollection('articles', ({ data }) => !data.draft);
const sortedArticles = allArticles.sort(
  (a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf()
);

const pillarArticles = allArticles.filter((a) => a.data.articleType === 'pillar');

const categories = [
  { slug: 'gas', label: 'GAS自動化', border: 'border-l-[#0F9D58]' },
  { slug: 'discord-bot', label: 'Discord Bot', border: 'border-l-[#5865F2]' },
  { slug: 'ai-api', label: 'AI API連携', border: 'border-l-[#FF6B35]' },
  { slug: 'no-code', label: 'ノーコード', border: 'border-l-[#7C3AED]' },
  { slug: 'frameworks', label: 'フレームワーク', border: 'border-l-[#2563EB]' },
  { slug: 'reviews', label: 'レビュー・比較', border: 'border-l-[#DC2626]' },
];

const articleCounts: Record<string, number> = {};
for (const cat of categories) {
  articleCounts[cat.slug] = allArticles.filter((a) => a.data.category === cat.slug).length;
}

const jsonLd = generateWebSiteJsonLd();

const formatDate = (date: Date) =>
  date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
---

<BaseLayout
  title="AI Automate Lab | 中小企業のAI業務自動化ナレッジベース"
  description="中小企業のAI業務自動化を、フレームワークで再現可能にするナレッジベース。GAS、Discord Bot、AI API、ノーコードツールの実践的な活用法を解説。"
  jsonLd={jsonLd}
>
  <!-- Hero -->
  <section class="bg-gray-50 py-16 md:py-20">
    <div class="container text-center">
      <h1 class="text-3xl md:text-4xl font-bold mb-3">
        中小企業のAI業務自動化を、<br class="hidden md:block" />フレームワークで再現可能にする
      </h1>
      <p class="text-base text-gray-500 mb-8 max-w-xl mx-auto">
        実務経験に基づく一次情報を体系化したナレッジベース
      </p>
      <div class="max-w-lg mx-auto">
        <SearchBar />
      </div>
    </div>
  </section>

  <!-- Categories -->
  <section id="categories" class="py-16">
    <div class="container">
    <h2 class="text-2xl font-bold mb-8 text-center">カテゴリ</h2>
    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
      {categories.map((cat) => (
        <a
          href={`/category/${cat.slug}/`}
          class:list={[
            'block border-l-2 pl-4 py-3 hover:bg-gray-50 transition-colors no-underline rounded-r',
            cat.border,
          ]}
        >
          <h3 class="text-sm font-bold text-gray-800">{cat.label}</h3>
          <p class="text-xs text-gray-400 mt-0.5">{articleCounts[cat.slug]}件</p>
        </a>
      ))}
    </div>
    </div>
  </section>

  <!-- Pillar Articles -->
  {pillarArticles.length > 0 && (
    <section class="bg-gray-50 py-16">
      <div class="container">
        <h2 class="text-2xl font-bold mb-2 text-center">まず読むべき記事</h2>
        <p class="text-gray-600 text-center mb-8">各カテゴリの全体像を掴むピラー記事</p>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {pillarArticles.slice(0, 3).map((article) => (
            <a
              href={`/articles/${article.slug}/`}
              class="block bg-white p-6 rounded-xl border-2 border-brand/20 hover:border-brand hover:shadow-md transition-all no-underline"
            >
              <span class="inline-block text-xs font-semibold text-brand bg-blue-50 px-2 py-1 rounded mb-3">
                ピラー記事
              </span>
              <h3 class="text-base font-bold text-gray-800 mb-2 leading-snug">
                {article.data.title}
              </h3>
              <p class="text-sm text-gray-500 line-clamp-2">
                {article.data.description}
              </p>
            </a>
          ))}
        </div>
      </div>
    </section>
  )}

  <!-- Latest Articles -->
  <section class="py-16">
    <div class="container">
      <h2 class="text-2xl font-bold mb-8 text-center">最新記事</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {sortedArticles.slice(0, 6).map((article) => (
          <a
            href={`/articles/${article.slug}/`}
            class="block bg-white p-6 rounded-xl border border-gray-200 hover:shadow-md transition-all no-underline"
          >
            <span class="inline-block text-xs font-medium text-brand bg-blue-50 px-2 py-0.5 rounded mb-3">
              {article.data.category}
            </span>
            <h3 class="text-base font-bold text-gray-800 mb-2 leading-snug">
              {article.data.title}
            </h3>
            <p class="text-sm text-gray-500 mb-3 line-clamp-2">
              {article.data.description}
            </p>
            <div class="flex items-center gap-2 text-xs text-gray-400">
              <time datetime={article.data.publishedAt.toISOString()}>
                {formatDate(article.data.publishedAt)}
              </time>
              <span>・約{article.data.timeToRead}分</span>
            </div>
          </a>
        ))}
      </div>
    </div>
  </section>
</BaseLayout>
