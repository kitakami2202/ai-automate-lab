---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Breadcrumb from '../../components/Breadcrumb.astro';
import { categoryLabels, difficultyLabels, difficultyColors } from '../../utils/categories';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const allArticles = await getCollection('articles', ({ data }) => !data.draft);
  const tagSet = new Set<string>();
  for (const article of allArticles) {
    for (const tag of article.data.tags) {
      tagSet.add(tag);
    }
  }

  return [...tagSet].map((tag) => ({
    params: { tag },
    props: {
      tagName: tag,
      articles: allArticles
        .filter((a) => a.data.tags.includes(tag))
        .sort((a, b) => b.data.publishedAt.valueOf() - a.data.publishedAt.valueOf()),
    },
  }));
}

const { tagName, articles } = Astro.props;

const formatDate = (date: Date) =>
  date.toLocaleDateString('ja-JP', { year: 'numeric', month: 'long', day: 'numeric' });
---

<BaseLayout
  title={`#${tagName} の記事一覧 | AI Automate Lab`}
  description={`「${tagName}」タグが付いた記事の一覧です。${articles.length}件の記事があります。`}
>
  <div class="container py-10">
    <Breadcrumb items={[
      { name: 'タグ一覧', url: '/tags/' },
      { name: `#${tagName}`, url: `/tags/${tagName}/` },
    ]} />

    <h1 class="text-3xl font-bold mb-4">#{tagName}</h1>
    <p class="text-gray-600 mb-8">{articles.length}件の記事</p>

    <div class="space-y-4">
      {articles.map((article: any) => (
        <a
          href={`/articles/${article.slug}/`}
          class="block p-6 border border-gray-200 rounded-lg hover:shadow-sm transition-all no-underline"
        >
          <div class="flex items-center gap-2 mb-2">
            <span class="text-xs font-medium text-brand bg-blue-50 px-2 py-0.5 rounded">
              {categoryLabels[article.data.category] || article.data.category}
            </span>
            {article.data.difficulty && (
              <span class={`text-xs px-2 py-0.5 rounded ${difficultyColors[article.data.difficulty] || ''}`}>
                {difficultyLabels[article.data.difficulty] || article.data.difficulty}
              </span>
            )}
            {article.data.articleType === 'pillar' && (
              <span class="text-xs font-bold bg-brand text-white px-2 py-0.5 rounded">ピラー記事</span>
            )}
          </div>
          <h2 class="text-lg font-bold text-gray-800 mb-2">{article.data.title}</h2>
          <p class="text-sm text-gray-600 mb-3">{article.data.description}</p>
          <div class="flex items-center gap-3">
            <time class="text-xs text-gray-400" datetime={article.data.publishedAt.toISOString()}>
              {formatDate(article.data.publishedAt)}
            </time>
            {article.data.timeToRead && (
              <span class="text-xs text-gray-500">約{article.data.timeToRead}分</span>
            )}
          </div>
        </a>
      ))}
    </div>
  </div>
</BaseLayout>
